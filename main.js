(()=>{"use strict";function t(){const t=new Date;let e=String(t.getMonth());return 1===e.length&&(e=`0${e}`),`${t.getDate()}.${e}.${t.getFullYear()} ${t.getHours()}:${t.getMinutes()}`}class e{constructor(t,e){this.messages=document.querySelector(".message__list"),this.text=t,this.geopos=e}getPost(){const e=document.createElement("li");e.classList.add("message__item");const s=document.createElement("time");s.classList.add("timestamp"),s.textContent=t();const n=document.createElement("div");n.classList.add("message__box");const o=document.createElement("div");o.classList.add("message__content"),o.textContent=this.text;const a=document.createElement("div");a.classList.add("message__geo"),a.textContent=this.geopos,n.append(o),n.append(a),e.append(s),e.append(n),this.messages.prepend(e)}}function s(){return new Promise(((t,e)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((function(e){const{latitude:s,longitude:n}=e.coords;t({latitude:+s.toFixed(5),longitude:+n.toFixed(5)})}),(function(t){e(t)})):e(new Error("close"))}))}class n{constructor(){this.body=document.querySelector("body"),this.modalForm=null,this.createModal()}showMistake(t){const e=document.createElement("div");e.classList.add("mistake-modal"),e.textContent=`*${t}`,this.modalForm.querySelector("label").append(e)}createModal(){const t=document.createElement("div");t.classList.add("modal");const e=document.createElement("form");e.classList.add("form"),t.append(e);const s=document.createElement("h1");s.classList.add("modal__title"),s.textContent="Что-то пошло не так";const n=document.createElement("span");n.classList.add("modal__text"),n.textContent="К сожалению нам не удалось определить ваше местоположение, пожалуйста, дайте разрешение на использование геолокации, либо введите координаты вручную";const o=document.createElement("label"),a=document.createElement("span");a.textContent="Широта и долгота через запятую";const c=document.createElement("input");c.type="text",c.name="geopos",c.classList.add("modal__input"),o.append(a),o.append(c);const r=document.createElement("div");r.classList.add("modal__control");const i=document.createElement("button");i.classList.add("btn-modal","cancel-btn"),i.textContent="Отмена";const d=document.createElement("button");d.classList.add("btn-modal","ok-btn"),d.textContent="ok",r.append(i),r.append(d),e.append(s),e.append(n),e.append(o),e.append(r),this.body.append(t)}}function o(t){if(t.match(/[^0-9[\]-\s.,]/g))throw new Error("");const e=t.replace(/[[\]\s+]/g,"").split(",");return{latitude:Number(e[0]),longitude:Number(e[1])}}class a{constructor(){this.control=document.querySelector(".text-control"),this.messages=document.querySelector(".message__list"),this.ctrlAudio=null,this.timer=null}createAudioPost(e,s){const n=document.createElement("li");n.classList.add("message__item");const o=document.createElement("time");o.classList.add("timestamp"),o.textContent=t();const a=document.createElement("div");a.classList.add("message__box");const c=document.createElement("audio");c.classList.add("message__content"),c.src=s,c.controls=!0;const r=document.createElement("div");r.classList.add("message__geo"),r.textContent=e,a.append(c),a.append(r),n.append(o),n.append(a),this.messages.prepend(n)}createAudioCtrl(){const t=document.createElement("div");t.classList.add("audio-control","ctrl");const e=document.createElement("button");e.classList.add("ready-btn","btn"),e.textContent="✔",e.title="Готово";const s=document.createElement("button");s.classList.add("btn-cancel","btn"),s.textContent="X",s.title="Отмена";const n=document.createElement("span");n.classList.add("timer"),n.textContent="00:00",t.append(e),t.append(n),t.append(s),this.ctrlAudio=t,this.timer=n,this.control.replaceWith(t)}remoteAudioCtrl(){this.ctrlAudio.replaceWith(this.control)}}class c{constructor(){this.control=document.querySelector(".text-control"),this.messages=document.querySelector(".message__list"),this.ctrlVideo=null,this.timer=null}createVideoPost(e,s){const n=document.createElement("li");n.classList.add("message__item");const o=document.createElement("time");o.classList.add("timestamp"),o.textContent=t();const a=document.createElement("div");a.classList.add("message__box");const c=document.createElement("video");c.classList.add("message__content"),c.src=s,c.controls=!0;const r=document.createElement("div");r.classList.add("message__geo"),r.textContent=e,a.append(c),a.append(r),n.append(o),n.append(a),this.messages.prepend(n)}createVideoCtrl(){const t=document.createElement("div");t.classList.add("video-control","ctrl");const e=document.createElement("button");e.classList.add("ready-btn","btn"),e.textContent="✔",e.title="Готово";const s=document.createElement("button");s.classList.add("btn-cancel","btn"),s.textContent="X",s.title="Отмена";const n=document.createElement("span");n.classList.add("timer"),n.textContent="00:00",t.append(e),t.append(n),t.append(s),this.ctrlVideo=t,this.timer=n,this.control.replaceWith(t)}remoteVideoCtrl(){this.ctrlVideo.replaceWith(this.control)}}(new class{constructor(){this.control=document.querySelector(".control"),this.textarea=this.control.querySelector(".textarea"),this.modal=null,this.post=null}init(){this.control.addEventListener("click",(t=>this.getEvent(t))),this.textarea.addEventListener("keydown",(t=>this.getInput(t)))}getEvent(t){t.preventDefault(),t.target.classList.contains("audio-btn")&&(t.preventDefault(),console.log("audio"),async function(){if(!navigator.mediaDevices||!window.MediaRecorder)throw new Error("Запись аудио недоступна");try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),e=new MediaRecorder(t),c=new a;c.createAudioCtrl();let r=0,i=0,d=!1;const l=[];e.start(1e3),e.addEventListener("dataavailable",(t=>{const e=r<10?`0${r}`:`${r}`,s=i<10?`0${i}`:`${i}`;c.timer.textContent=`${s}:${e}`,r+=1,r>60&&(r=0,i+=1),l.push(t.data)})),e.addEventListener("stop",(()=>{c.remoteAudioCtrl();const e=new Blob(l),a=URL.createObjectURL(e);t.getTracks().forEach((t=>t.stop())),d&&s().then((t=>{const{latitude:e,longitude:s}=t;c.createAudioPost(`[${e}, ${s}]`,a)})).catch((()=>{const t=new n;t.modalForm=document.querySelector(".modal"),t.modalForm.addEventListener("click",(e=>{if(e.preventDefault(),!e.target.classList.contains("cancel-btn")&&e.target.closest(".form")||e.currentTarget.remove(),e.currentTarget.querySelector(".mistake-modal")&&e.currentTarget.querySelector(".mistake-modal").remove(),e.target.classList.contains("ok-btn")){const s=e.currentTarget.querySelector(".form").geopos.value;if(""!==s)try{const t=o(s);e.currentTarget.remove(),c.createAudioPost(`[${t.latitude}, ${t.longitude}]`,a)}catch(e){t.showMistake("Введены неверные данные")}else t.showMistake("Пустая строка")}}))}))})),c.ctrlAudio.addEventListener("click",(t=>{t.target.classList.contains("btn-cancel")&&e.stop(),t.target.classList.contains("ready-btn")&&(d=!0,e.stop())}))}catch(t){throw new Error("Запись аудио недоступна")}}().catch((t=>this.showMistake(this.textarea,t)))),t.target.classList.contains("video-btn")&&(console.log("video"),async function(){if(!navigator.mediaDevices||!window.MediaRecorder)throw new Error("Запись видео недоступна");try{const t=await navigator.mediaDevices.getUserMedia({video:!0}),e=new MediaRecorder(t),a=new c;a.createVideoCtrl();let r=0,i=0,d=!1;const l=[];e.start(1e3),e.addEventListener("dataavailable",(t=>{const e=r<10?`0${r}`:`${r}`,s=i<10?`0${i}`:`${i}`;a.timer.textContent=`${s}:${e}`,r+=1,r>60&&(r=0,i+=1),l.push(t.data)})),e.addEventListener("stop",(()=>{a.remoteVideoCtrl();const e=new Blob(l),c=URL.createObjectURL(e);t.getTracks().forEach((t=>t.stop())),d&&s().then((t=>{const{latitude:e,longitude:s}=t;a.createVideoPost(`[${e}, ${s}]`,c)})).catch((()=>{const t=new n;t.modalForm=document.querySelector(".modal"),t.modalForm.addEventListener("click",(e=>{if(e.preventDefault(),!e.target.classList.contains("cancel-btn")&&e.target.closest(".form")||e.currentTarget.remove(),e.currentTarget.querySelector(".mistake-modal")&&e.currentTarget.querySelector(".mistake-modal").remove(),e.target.classList.contains("ok-btn")){const s=e.currentTarget.querySelector(".form").geopos.value;if(""!==s)try{const t=o(s);e.currentTarget.remove(),a.createVideoPost(`[${t.latitude}, ${t.longitude}]`,c)}catch(e){t.showMistake("Введены неверные данные")}else t.showMistake("Пустая строка")}}))}))})),a.ctrlVideo.addEventListener("click",(t=>{t.target.classList.contains("btn-cancel")&&e.stop(),t.target.classList.contains("ready-btn")&&(d=!0,e.stop())}))}catch(t){throw new Error("Запись видео недоступна")}}().catch((t=>this.showMistake(this.textarea,t))))}getInput(t){document.querySelector(".mistake")&&this.removeMistake(),"Enter"===t.key&&(t.preventDefault(),""===t.currentTarget.value?this.showMistake(t.currentTarget,"Заполните поле"):s().then((t=>{const{latitude:s,longitude:n}=t;this.post=new e(this.textarea.value,`[${s}, ${n}]`),this.post.getPost(),this.textarea.value=""})).catch((()=>{this.modal=new n,this.adminModal()})))}adminModal(){this.modal.modalForm=document.querySelector(".modal"),this.modal.modalForm.addEventListener("click",(t=>this.eventModal(t)))}eventModal(t){if(t.preventDefault(),t.target.classList.contains("cancel-btn")||!t.target.closest(".form"))return t.currentTarget.remove(),void(this.modal=null);if(t.currentTarget.querySelector(".mistake-modal")&&t.currentTarget.querySelector(".mistake-modal").remove(),t.target.classList.contains("ok-btn")){const s=t.currentTarget.querySelector(".form").geopos.value;if(""!==s)try{const n=o(s);t.currentTarget.remove(),this.modal=null,this.post=new e(this.textarea.value,`[${n.latitude}, ${n.longitude}]`),this.post.getPost(),this.textarea.value=""}catch(t){this.modal.showMistake("Введены неверные данные")}else this.modal.showMistake("Пустая строка")}}showMistake(t,e){const s=document.createElement("div");s.classList.add("mistake"),s.textContent=e,t.after(s)}removeMistake(){document.querySelector(".mistake").remove()}}).init()})();